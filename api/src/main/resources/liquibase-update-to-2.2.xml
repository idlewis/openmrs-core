<?xml version="1.0" encoding="UTF-8"?>
<!--

    This Source Code Form is subject to the terms of the Mozilla Public License,
    v. 2.0. If a copy of the MPL was not distributed with this file, You can
    obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under
    the terms of the Healthcare Disclaimer located at http://openmrs.org/license.

    Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS
    graphic logo is a trademark of OpenMRS Inc.

-->
<!--
    This file contains all changesets that have been introduced on top of liquibase-update-to-2.0.xml exclusively.
    If you intend for a changeset to be backported to older releases, you must put such a changeset in the
    liquibase-update-to-2.0.xml, which have been used for older releases.
-->
<databaseChangeLog logicalFilePath="liquibase-update-to-latest.xml" xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<!--
		See http://www.liquibase.org/manual/home#available_database_refactorings
		for a list of supported elements and attributes
	-->
	<changeSet id="TRUNK-4755" author="Rahul,Swathi">
            <preConditions onFail="MARK_RAN">
                <not>
                    <tableExists tableName="program_attribute_type" />
                </not>
            </preConditions>
            <comment>Creating program_attribute_type table</comment>
            <createTable tableName="program_attribute_type">
                <column name="program_attribute_type_id" type="int" autoIncrement="true">
                    <constraints primaryKey="true" nullable="false" />
                </column>
                <column name="name" type="varchar(255)">
                    <constraints nullable="false"  unique="true"/>
                </column>
                <column name="description" type="varchar(1024)" />
                <column name="datatype" type="varchar(255)" />
                <column name="datatype_config" type="text" />
                <column name="preferred_handler" type="varchar(255)" />
                <column name="handler_config" type="text" />
                <column name="min_occurs" type="int">
                    <constraints nullable="false" />
                </column>
                <column name="max_occurs" type="int"></column>
                <column name="creator" type="int">
                    <constraints nullable="false" />
                </column>
                <column name="date_created" type="datetime">
                    <constraints nullable="false" />
                </column>
                <column name="changed_by" type="int" />
                <column name="date_changed" type="datetime" />
                <column name="retired" type="boolean" defaultValueBoolean="false">
                    <constraints nullable="false" />
                </column>
                <column name="retired_by" type="int(11)" />
                <column name="date_retired" type="datetime" />
                <column name="retire_reason" type="varchar(255)" defaultValue="null" />
                <column name="uuid" type="char(38)">
                    <constraints nullable="false" unique="true" />
                </column>
            </createTable>
            <addForeignKeyConstraint constraintName="program_attribute_type_creator_fk"
                                     baseTableName="program_attribute_type" baseColumnNames="creator"
                                     referencedTableName="users" referencedColumnNames="user_id" />
            <addForeignKeyConstraint constraintName="program_attribute_type_changed_by_fk"
                                     baseTableName="program_attribute_type" baseColumnNames="changed_by"
                                     referencedTableName="users" referencedColumnNames="user_id" />
            <addForeignKeyConstraint constraintName="program_attribute_type_retired_by_fk"
                                     baseTableName="program_attribute_type" baseColumnNames="retired_by"
                                     referencedTableName="users" referencedColumnNames="user_id" />
        </changeSet>
        <changeSet id="20151218-1729" author="Rahul,Swathi">
            <preConditions onFail="MARK_RAN">
                <not>
                    <tableExists tableName="patient_program_attribute" />
                </not>
            </preConditions>
             <comment>Creating patient_program_attribute table</comment>
            <createTable tableName="patient_program_attribute">
                <column name="patient_program_attribute_id" type="int" autoIncrement="true">
                    <constraints primaryKey="true" nullable="false" />
                </column>
                <column name="patient_program_id" type="int"><constraints nullable="false" /></column>
                <column name="attribute_type_id" type="int"><constraints nullable="false" /></column>
                <column name="value_reference" type="text"><constraints nullable="false" /></column>
                <column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
                <column name="creator" type="int"><constraints nullable="false"/></column>
                <column name="date_created" type="datetime"><constraints nullable="false"/></column>
                <column name="changed_by" type="int"/>
                <column name="date_changed" type="datetime" />
                <column name="voided" type="boolean" defaultValueBoolean="false">
                    <constraints nullable="false" />
                </column>
                <column name="voided_by" type="int" />
                <column name="date_voided" type="datetime" />
                <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            </createTable>
            <addForeignKeyConstraint constraintName="patient_program_attribute_programid_fk"
                                     baseTableName="patient_program_attribute" baseColumnNames="patient_program_id"
                                     referencedTableName="patient_program" referencedColumnNames="patient_program_id" />
            <addForeignKeyConstraint constraintName="patient_program_attribute_attributetype_fk"
                                     baseTableName="patient_program_attribute" baseColumnNames="attribute_type_id"
                                     referencedTableName="program_attribute_type" referencedColumnNames="program_attribute_type_id" />
            <addForeignKeyConstraint constraintName="patient_program_attribute_creator_fk"
                                     baseTableName="patient_program_attribute" baseColumnNames="creator"
                                     referencedTableName="users" referencedColumnNames="user_id" />
            <addForeignKeyConstraint constraintName="patient_program_attribute_changed_by_fk"
                                     baseTableName="patient_program_attribute" baseColumnNames="changed_by"
                                     referencedTableName="users" referencedColumnNames="user_id" />
            <addForeignKeyConstraint constraintName="patient_program_attribute_voided_by_fk"
                                     baseTableName="patient_program_attribute" baseColumnNames="voided_by"
            referencedTableName="users" referencedColumnNames="user_id" />
    </changeSet>
	<changeSet author="Kelechi+iheanyi" id="20180508-1000">
		<preConditions onFail="MARK_RAN">
			<tableExists tableName="conditions"/>
		</preConditions>
		<comment>
			Rename conditions table to emrapi_conditions
		</comment>
		<renameTable newTableName="emrapi_conditions" oldTableName="conditions" />
	</changeSet>
	<changeSet id="20180508-1001" author="Kelechi+iheanyi">
		<preConditions onFail="MARK_RAN">
			<not><tableExists tableName="conditions"/></not>
		</preConditions>
		<comment>
			Add conditions table
		</comment>
		<createTable tableName="conditions">
			<column name="condition_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="additional_detail" type="varchar(255)">
				<constraints nullable="true"/>
			</column>
			<column name="previous_version" type="int"></column>
			<column name="condition_coded" type="int" />
			<column name="condition_non_coded" type="varchar(255)" />
			<column name="condition_coded_name" type="int" />
			<column name="clinical_status" type="varchar(50)" >
				<constraints nullable="false" />
			</column>
			<column name="verification_status" type="varchar(50)" >
				<constraints nullable="true"/>
			</column>
			<column name="onset_date" type="datetime" />
			<column name="date_created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="voided" type="boolean" defaultValueBoolean="false">
				<constraints nullable="false" />
			</column>
			<column name="date_voided" type="datetime" />
			<column name="void_reason" type="varchar(255)" />
			<column name="uuid" type="varchar(38)">
				<constraints unique="true" />
			</column>
			<column name="creator" type="int">
				<constraints nullable="false" />
			</column>
			<column name="voided_by" type="int" />
			<column name="changed_by" type="int" />
			<column name="patient_id" type="int"><constraints nullable="false" /></column>
			<column name="end_date" type="datetime" />
		</createTable>
		<addForeignKeyConstraint constraintName="condition_previous_version_fk"
								 baseTableName="conditions" baseColumnNames="previous_version"
								 referencedTableName="conditions" referencedColumnNames="condition_id" />
		<addForeignKeyConstraint constraintName="condition_condition_coded_fk"
								 baseTableName="conditions" baseColumnNames="condition_coded"
								 referencedTableName="concept" referencedColumnNames="concept_id " />
		<addForeignKeyConstraint constraintName="condition_condition_coded_name_fk"
								 baseTableName="conditions" baseColumnNames="condition_coded_name"
								 referencedTableName="concept_name" referencedColumnNames="concept_name_id " />
		<addForeignKeyConstraint constraintName="condition_creator_fk"
								 baseTableName="conditions" baseColumnNames="creator"
								 referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="condition_changed_by_fk"
								 baseTableName="conditions" baseColumnNames="changed_by"
								 referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="condition_voided_by_fk"
								 baseTableName="conditions" baseColumnNames="voided_by"
								 referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="condition_patient_fk"
								 baseTableName="conditions" baseColumnNames="patient_id"
								 referencedTableName="patient" referencedColumnNames="patient_id" />
	</changeSet>
	<changeSet id="20180508-1002" author="Kelechi+iheanyi">
		<preConditions onFail="MARK_RAN">
			<tableExists tableName="emrapi_conditions" />
			<tableExists tableName="conditions" />
		</preConditions>
		<comment>
			Migrate data from the emrapi_conditions table to the new conditions table
		</comment>
		<sql>
			INSERT into `conditions` (condition_id, previous_version, patient_id, clinical_status, condition_non_coded, condition_coded, onset_date, additional_detail, end_date, creator, date_created, voided, voided_by, date_voided, void_reason, uuid)
			SELECT condition_id, previous_condition_id, patient_id, status, condition_non_coded, concept_id, onset_date, additional_detail, end_date, creator, date_created, voided, voided_by, date_voided, void_reason, uuid FROM `emrapi_conditions`;
		</sql>
	</changeSet>
	<changeSet id="20181402-TRUNK-5339" author="esirkings">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="encounter_diagnosis" />
			</not>
		</preConditions>

		<comment>Creating encounter_diagnosis table</comment>
		<createTable tableName="encounter_diagnosis">
			<column name="diagnosis_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="diagnosis_coded" type="int" />
			<column name="diagnosis_non_coded" type="varchar(255)" />
			<column name="diagnosis_coded_name" type="int" />
			<column name="encounter_id" type="int"><constraints nullable="false" /></column>
			<column name="patient_id" type="int"><constraints nullable="false" /></column>
			<column name="condition_id" type="int"><constraints nullable="true" /></column>
			<column name="certainty" type="varchar(255)"><constraints nullable="false" /></column>
			<column name="rank" type="int"><constraints nullable="false" /></column>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
			<column name="creator" type="int"><constraints nullable="false"/></column>
			<column name="date_created" type="datetime"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="datetime" />
			<column name="voided" type="boolean" defaultValueBoolean="false">
				<constraints nullable="false" />
			</column>
			<column name="voided_by" type="int" />
			<column name="date_voided" type="datetime" />
			<column name="void_reason" type="varchar(255)"/>
		</createTable>
		
		<addForeignKeyConstraint constraintName="encounter_diagnosis_encounter_id_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="encounter_id"
								 referencedTableName="encounter" referencedColumnNames="encounter_id" />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_patient_id_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="patient_id"
								 referencedTableName="patient" referencedColumnNames="patient_id" />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_condition_id_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="condition_id"
								 referencedTableName="conditions" referencedColumnNames="condition_id" />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_creator_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="creator"
								 referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_voided_by_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="voided_by"
								 referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_changed_by_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="changed_by"
								 referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_coded_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="diagnosis_coded"
								 referencedTableName="concept" referencedColumnNames="concept_id " />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_coded_name_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="diagnosis_coded_name"
								 referencedTableName="concept_name" referencedColumnNames="concept_name_id " />
		<addForeignKeyConstraint constraintName="encounter_diagnosis_patient_fk"
								 baseTableName="encounter_diagnosis" baseColumnNames="patient_id"
								 referencedTableName="patient" referencedColumnNames="patient_id" />
	</changeSet>
	<changeSet id="20180405131015-TRUNK-5333" author="alicerowan">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="concept_numeric" columnName="precise"/>
		</preConditions>
		<comment>Rename concept_numeric.precise to concept_numeric.allow_decimal</comment>
		<renameColumn oldColumnName="precise" newColumnName="allow_decimal" tableName="concept_numeric"  columnDataType="BOOLEAN"/>
	</changeSet>
	<changeSet id="TRUNK-4791-20180215" author="patrick">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="provider" columnName="role_id"/>
			</not>
		</preConditions>
		<comment>Adding role_id column to provider table</comment>
		<addColumn tableName="provider">
			<column name="role_id" type="int" />
		</addColumn>
		<addForeignKeyConstraint baseTableName="provider"
								 baseColumnNames="role_id"
								 constraintName="provider_role_id_fk"
								 referencedTableName="concept"
								 referencedColumnNames="concept_id" />
	</changeSet>
	<changeSet id="TRUNK-4791-20180216" author="patrick">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="provider" columnName="speciality_id"/>
			</not>
		</preConditions>
		<comment>Adding speciality_id column to provider table</comment>
		<addColumn tableName="provider">
			<column name="speciality_id" type="int" />
		</addColumn>
		<addForeignKeyConstraint baseTableName="provider"
								 baseColumnNames="speciality_id"
								 constraintName="provider_speciality_id_fk"
								 referencedTableName="concept"
								 referencedColumnNames="concept_id" />
	</changeSet>
	
	<changeSet id="20180728-1211-TRUNK-" author="rdahlman3">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="order_reason_concept_id" tableName="order_group"/>
			</not>
		</preConditions>
		<comment>Adding 'order_reason_concept_id' column to order group table</comment>
		<addColumn tableName="order_group">
			<column name="order_reason_concept_id" type="int" />
		</addColumn>
		<addForeignKeyConstraint constraintName="order_group_order_reason_concept_fk"
			baseTableName="order_group" baseColumnNames="order_reason_concept_id"
			referencedTableName="concept" referencedColumnNames="concept_id" />
	</changeSet>
	
    <changeSet id="201807281250-TRUNK-" author="rdahlman3">
        <preConditions onFail="MARK_RAN">
            <not>
            		<columnExists columnName="previous_order_group_id" tableName="order_group"/>
            	</not>
        </preConditions>

        <comment>Adding 'previous_order_group_id' to order_group table</comment>

        <addColumn tableName="order_group">
            <column name="previous_order_group_id" type="int" />
        </addColumn>

        <addForeignKeyConstraint constraintName="order_group_previous_order_group_id" baseTableName="order_group" baseColumnNames="previous_order_group_id" referencedTableName="order_group" referencedColumnNames="order_group_id"/>
    </changeSet>
	
    <changeSet id="201807281258-TRUNK-" author="rdahlman3">
        <preConditions onFail="MARK_RAN">
            <not>
            		<columnExists columnName="parent_order_group_id" tableName="order_group"/>
            	</not>
        </preConditions>

        <comment>Adding 'parent_order_group_id' to order_group table</comment>

        <addColumn tableName="order_group">
            <column name="parent_order_group_id" type="int" />
        </addColumn>

        <addForeignKeyConstraint constraintName="order_group_parent_order_group_id" baseTableName="order_group" baseColumnNames="parent_order_group_id" referencedTableName="order_group" referencedColumnNames="order_group_id"/>
    </changeSet>	
	
	
	
	<changeSet id="20180726-1325" author="ilewis">
		<comment>Creating order_group_attribute_type table</comment>
		<createTable tableName="order_group_attribute_type">
			<column name="order_group_attribute_type_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(255)">
				<constraints nullable="false" unique="true"/>
			</column>
			<column name="description" type="varchar(1024)" />
			<column name="datatype" type="varchar(255)" />
			<column name="datatype_config" type="text" />
			<column name="preferred_handler" type="varchar(255)" />
			<column name="handler_config" type="text" />
			<column name="min_occurs" type="int">
				<constraints nullable="false" />
			</column>
			<column name="max_occurs" type="int"></column>
			<column name="creator" type="int">
				<constraints nullable="false" />
			</column>
			<column name="date_created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="changed_by" type="int" />
			<column name="date_changed" type="datetime" />
			<column name="retired" type="boolean" defaultValueBoolean="false">
				<constraints nullable="false" />
			</column>
			<column name="retired_by" type="int" />
			<column name="date_retired" type="datetime" />
			<column name="retire_reason" type="varchar(255)" defaultValue="null" />
			<column name="uuid" type="char(38)">
				<constraints nullable="false" unique="true" />
			</column>
		</createTable>
		<addForeignKeyConstraint constraintName="order_group_attribute_type_creator_fk" baseTableName="order_group_attribute_type" baseColumnNames="creator" referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="order_group_attribute_type_changed_by_fk" baseTableName="order_group_attribute_type" baseColumnNames="changed_by" referencedTableName="users" referencedColumnNames="user_id"/>
		<addForeignKeyConstraint constraintName="order_group_attribute_type_retired_by_fk" baseTableName="order_group_attribute_type" baseColumnNames="retired_by" referencedTableName="users" referencedColumnNames="user_id"/>
		<modifySql dbms="mssql">
			<replace replace="CHAR(38)" with="UNIQUEIDENTIFIER DEFAULT NEWSEQUENTIALID()"/>
		</modifySql>
	</changeSet>	
	
	<changeSet id="20180726-1444" author="ilewis">
		<comment>Creating order_group_attribute table</comment>
		<createTable tableName="order_group_attribute">
			<column name="order_group_attribute_id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="order_group_id" type="int"><constraints nullable="false" /></column>
			<column name="attribute_type_id" type="int"><constraints nullable="false" /></column>
			<column name="value_reference" type="text"><constraints nullable="false" /></column>
			<column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
			<column name="creator" type="int"><constraints nullable="false"/></column>
			<column name="date_created" type="datetime"><constraints nullable="false"/></column>
			<column name="changed_by" type="int"/>
			<column name="date_changed" type="datetime" />
			<column name="voided" type="boolean" defaultValueBoolean="false">
				<constraints nullable="false"/>
			</column>
			<column name="voided_by" type="int" />
			<column name="date_voided" type="datetime" />
			<column name="void_reason" type="varchar(255)" defaultValue="null"/>
		</createTable>
		<addForeignKeyConstraint constraintName="order_group_attribute_order_group_fk" baseTableName="order_group_attribute" baseColumnNames="order_group_id" referencedTableName="order_group" referencedColumnNames="order_group_id" />
		<addForeignKeyConstraint constraintName="order_group_attribute_attribute_type_id_fk" baseTableName="order_group_attribute" baseColumnNames="attribute_type_id" referencedTableName="order_group_attribute_type" referencedColumnNames="order_group_attribute_type_id" />
		<addForeignKeyConstraint constraintName="order_group_attribute_creator_fk" baseTableName="order_group_attribute" baseColumnNames="creator" referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="order_group_attribute_changed_by_fk" baseTableName="order_group_attribute" baseColumnNames="changed_by" referencedTableName="users" referencedColumnNames="user_id" />
		<addForeignKeyConstraint constraintName="order_group_attribute_voided_by_fk" baseTableName="order_group_attribute" baseColumnNames="voided_by" referencedTableName="users" referencedColumnNames="user_id" />
	</changeSet>
</databaseChangeLog>
